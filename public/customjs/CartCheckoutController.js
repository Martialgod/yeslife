angular.module("app",["AppServices"]).constant("API_URL","/cart").config(["$httpProvider",function(t){t.defaults.headers.common["X-Requested-With"]="XMLHttpRequest"}]).controller("CartCheckoutController",["$http","API_URL","GlobalFactory",function(t,e,o){var a=this;a.statusmsg="retrieving cart...",a.isoncart=!0,$("#nodisplay-div").prop("hidden",!0),$("#cart-div").prop("hidden",!0),$("#divcheckout").prop("hidden",!0),a.mscproducts=[],a.msccoupons=[],a.recurringcoupons=[],a.mscstates=[],a.selectedstates={},a.selectedtaxrate=0,a.couponcode=null,a.paymentapi={},a.isloggedin=$("#isloggedin").val(),a.recurringtrxno=$("#recurringtrxno").val(),a.referrer_token=$("#referrer_token").val(),a.yeslife_referrer_id=$("#yeslife_referrer_id").val(),a.IsRecurringCoupons=function(t){var e=!1;return a.recurringcoupons.forEach(function(o,a){t.pk_coupons!=o.pk_coupons||(e=!0)}),e},a.LoadCart=function(){var e=getCartCookies();deleteAllCartCookies(),t.post("/cart",{cart:e,isloggedin:a.isloggedin,recurringtrxno:a.recurringtrxno}).then(function(t){var e=t.data;a.statusmsg="","empty"!=e?($("#nodisplay-div").prop("hidden",!0),$("#cart-div").prop("hidden",!1),a.mscproducts=e.cart,a.mscstates=e.mscstates,a.recurringcoupons=e.recurringcoupons,a.recurringcoupons.forEach(function(t,e){a.msccoupons.push(t)}),a.SetSelectedStates(),a.mscproducts.forEach(function(t,e){document.cookie="yeslifecart_"+t.productid+"="+t.selectedqty+"; path=/"}),updateCartCookieCount()):($("#nodisplay-div").prop("hidden",!1),$("#cart-div").prop("hidden",!0)),hideCustomizeLoading()},function(t){console.log(t),swal("Opps!","Something went wrong!<br> please see log for details","error"),hideCustomizeLoading()})},a.UpdateCart=function(t,e){if(e.selectedqty=isNaN(e.selectedqty)||null==e.selectedqty||""==e.selectedqty?1:e.selectedqty,"plus"==t?e.selectedqty++:"minus"==t&&e.selectedqty--,e.selectedqty<=0&&(e.selectedqty=1),null==a.recurringtrxno||""==a.recurringtrxno){var o={productid:e.productid,qty:e.selectedqty};document.cookie="yeslifecart_"+o.productid+"=0; path=/",addCartCookie(o)}a.CalculateTotal()},a.ApplyCoupon=function(e){e.preventDefault(),null==a.couponcode||""==a.couponcode||a.couponcode.length<=3?swal("Opps!","Coupon Code not found!","warning"):a.totalnetamount<=0?swal("Opps!","You cannot add another coupon!","warning"):(showCustomizeLoading(),t.post("/api/searchcoupon",{couponcode:a.couponcode,userid:a.isloggedin}).then(function(t){var e=t.data;if(e.length>0){var o=!1;a.msccoupons.forEach(function(t,a){t.pk_coupons!=e[0].pk_coupons||(o=!0)}),o||a.msccoupons.push(e[0])}else swal("Opps!","Coupon Code not found!","warning");a.CalculateTotal(),hideCustomizeLoading()},function(t){console.log(t),swal("Opps!","Coupon Code not found!","error"),hideCustomizeLoading()}))},a.RemoveCoupons=function(t){a.msccoupons.forEach(function(e,o){e.pk_coupons==t.pk_coupons&&a.msccoupons.splice(o,1)}),a.CalculateTotal()},a.CalculateTotal=function(){a.totalqty=0,a.subtotal=0,a.totalamount=0,a.totalcoupondiscount=0,a.totaltax=0,a.totalshipcost=0,a.totalnetamount=0,a.selectedtaxrate=0,isEmpty(a.selectedstates)||($("#totaltax1").prop("hidden",!1),a.selectedtaxrate=parseFloat(a.selectedstates.taxrate)),a.mscproducts.forEach(function(t,e){a.totalqty+=parseFloat(t.selectedqty),t.totalamount=parseFloat(t.selectedqty)*parseFloat(t.cartdiscountedprice),t.coupondiscount=0,t.taxamount=0,t.shipamount=0,t.netamount=0,a.msccoupons.forEach(function(e,o){"Fixed"==e.type?t.coupondiscount+=parseFloat(e.amount)/parseFloat(a.mscproducts.length):t.coupondiscount+=parseFloat(t.totalamount)*(parseFloat(e.amount)/100)}),t.netamount=parseFloat(t.totalamount)-parseFloat(t.coupondiscount),t.taxamount=t.netamount*(a.selectedtaxrate/100),a.totalcoupondiscount+=parseFloat(t.coupondiscount),a.totaltax+=parseFloat(t.taxamount),a.totalamount+=parseFloat(t.totalamount),a.totalnetamount+=parseFloat(t.netamount)+parseFloat(t.taxamount),t.taxamount=parseFloat(t.taxamount).toFixed(2),t.coupondiscount=parseFloat(t.coupondiscount).toFixed(2),t.totalamount=parseFloat(t.totalamount).toFixed(2),t.netamount=parseFloat(t.netamount).toFixed(2)}),a.totaltax=parseFloat(a.totaltax).toFixed(2),a.totalcoupondiscount=parseFloat(a.totalcoupondiscount).toFixed(2),a.totalamount=parseFloat(a.totalamount).toFixed(2),a.totalnetamount=parseFloat(a.totalnetamount).toFixed(2),a.subtotal=parseFloat(a.totalamount)-parseFloat(a.totalcoupondiscount),a.subtotal=parseFloat(a.subtotal).toFixed(2),$("#totaltax1").html(" Sales Tax <span> $"+a.totaltax+"</span>"),$("#totaltax2").html(" Sales Tax <span> $"+a.totaltax+"</span>"),$("#grandtotal1").html(" Grand Total <span> $"+a.totalnetamount+"</span>"),$("#grandtotal2").html(" Grand Total <span> $"+a.totalnetamount+"</span>")},a.RemoveFromCart=function(t){a.mscproducts.forEach(function(e,o){e.productid==t.productid&&(a.mscproducts.splice(o,1),removeCartCookie(t.productid))}),0==a.mscproducts.length&&($("#nodisplay-div").prop("hidden",!1),$("#cart-div").prop("hidden",!0)),a.CalculateTotal()},a.IsCartItemsValid=function(){return a.mscproducts.length<=0?(swal("Opps!","Youre cart is empty!","error"),!1):!(a.totalnetamount<=0&&(swal("Opps!","Net amount cannot be zero!","error"),1))},a.ShowCart=function(){a.isoncart=!0,$("#cart-div").prop("hidden",!1),$("#divcheckout").prop("hidden",!0)},a.ShowCheckout=function(){a.IsCartItemsValid()&&(a.isoncart=!1,$("#cart-div").prop("hidden",!0),$("#divcheckout").prop("hidden",!1))},a.SubmitCart=function(){showCustomizeLoading(),t.post("/api/save-order",{referrer_token:a.referrer_token,yeslife_referrer_id:a.yeslife_referrer_id,recurringtrxno:a.recurringtrxno,cart:a.mscproducts,coupons:a.msccoupons,total:{totalamount:a.totalamount,totalnetamount:a.totalnetamount,totalcoupondiscount:a.totalcoupondiscount,totaltax:a.totaltax,totalshipcost:a.totalshipcost},paymentapi:a.paymentapi,address:$("#form-checkout").serializeArray()}).then(function(t){console.log(t);var e=t.data;"success"==e.status?(LeadDyno.recordPurchase($("#billingemail").val(),{purchase_code:e.trxno,purchase_amount:a.totalnetamount},function(){console.log("Purchase successfully sent to LeadDyno"),deleteAllCartCookies(),null!=a.referrer_token&&""!=a.referrer_token?location.href="/order/success/"+e.trxno+"?refno="+a.referrer_token:location.href="/order/success/"+e.trxno}),LeadDyno.devTools.setLogger(function(t){console.log("LeadDyno Log: "+t)})):hideCustomizeLoading()},function(t){console.log(t);var e=t.data;o.swalPostParamErrors(e),hideCustomizeLoading()})},$(document).on("submit","#form-checkout",function(t){if(t.preventDefault(),$("#form-checkout").valid()&&a.IsCartItemsValid()){if($("#isrecurring").is(":checked")){var e=o.formatDate(new Date,"yyyy-MM-dd"),n=new Date(e).getTime(),r=new Date($("#enddate").val()).getTime();if("undefined"!==$("#enddate").val()&&""!=$("#enddate").val()&&r<=n)return void swal("Opps!","Recurring end date should be greater than today!","error")}if(1!=$("#isnewaccount").prop("checked")||0!=$("#billingpassword").val().length&&$("#billingpassword").val()==$("#billingrepeatpassword").val()){if(a.rallycnumber=$("#rally_cardNumber").val().trim(),a.rallyexpDate=$("#rally_expDate").val().trim(),null==a.rallyexpDate||""==a.rallyexpDate||0==a.rallyexpDate.length)return $("#errrally_expDate").html("This is required!"),void $("#rally_expDate").focus();if($("#errrally_expDate").html(""),null==a.rallyexpDate.match(/^\d{1,2}\/\d{4}$/))return $("#errrally_expDate").html("Format should be (MM/YYYY)"),void $("#rally_expDate").focus();if($("#errrally_expDate").html(""),a.rallycvc=$("#rally_cvc").val().trim(),null==a.rallycvc||""==a.rallycvc||0==a.rallycvc.length)return $("#errrally_cvc").html("This is required!"),void $("#rally_cvc").focus();if($("#errrally_cvc").html(""),1!=/^\d{3,4}$/.test(a.rallycvc))return $("#errrally_cvc").html("Invalid CVC!"),void $("#rally_cvc").focus();a.procesRallyPay()}else swal("Opps!","Password does not match!","error")}}),a.procesRallyPay=function(){1==!$("#billingcantfindstate").prop("checked")?$("#billingstatesdropdown").val():$("#billingstatescustom").val(),a.paymentapi={cardno:$("#rally_cardNumber").val().trim().replace(/\s/g,""),exmonth:a.rallyexpDate.substring(0,2),exyear:a.rallyexpDate.substring(3,a.rallyexpDate.length),cvc:$("#rally_cvc").val().trim()},a.paymentapi.cardno,a.paymentapi.cvc,a.paymentapi.exmonth,a.paymentapi.exyear,a.totalnetamount,$("#billingemail").val(),$("#billingphone").val(),$("#billingfname").val(),$("#billinglname").val(),$("#billingaddress1").val(),$("#billingcity").val(),$("#billingcountry option:selected").text().trim(),$("#billingzip").val(),a.paymentapi={amount:100,currency:"usd",email:"test@gmail.com",id:"3213sdf",payment_token:"5dfgfd",transaction_number:"12312312dfsd",user:{email:"test@gmail.com",id:"1ftrt2"}},a.SubmitCart()},a.SetSelectedStates=function(){a.selectedstates={};var t="";t=1==$("#shiptodifferentaddress").prop("checked")?1==$("#shippingcantfindstate").prop("checked")?"":$("#shippingstatesdropdown").val():1==$("#billingcantfindstate").prop("checked")?"":$("#billingstatesdropdown").val();for(var e=a.mscstates.length,o=0;o<e;o++)if(a.mscstates[o].name==t){a.selectedstates=a.mscstates[o];break}a.CalculateTotal()},$(document).on("change","#billingstatesdropdown",function(){a.SetSelectedStates()}),$(document).on("change","#billingcantfindstate",function(){a.SetSelectedStates()}),$(document).on("change","#shiptodifferentaddress",function(){a.SetSelectedStates()}),$(document).on("change","#shippingstatesdropdown",function(){a.SetSelectedStates()}),$(document).on("change","#shippingcantfindstate",function(){a.SetSelectedStates()}),showCustomizeLoadingNoIcon(),setTimeout(function(){a.LoadCart()},500)}]);